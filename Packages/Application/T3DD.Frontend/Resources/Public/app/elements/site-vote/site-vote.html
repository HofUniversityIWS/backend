<link rel="import" href="../../bower_components/pvc-globals/pvc-globals.html">
<link rel="import" href="../site-style/site-style.html">
<link rel="import" href="../site-ajax/site-ajax.html">

<polymer-element name="site-vote" attributes="sessionResource voteUri">
	<template>
		<core-style ref="main"></core-style>
		<style>
			:host {
				display: block;
			}
			#button {
				color: #b4b4b4;
			}
			#button::shadow #ripple {
			  color: #FF8700;
			}
			#count, #button.voted {
				color: #595959;
			}
		</style>
		<pvc-globals values="{{globals}}"></pvc-globals>
		<site-ajax cache="true" url="/votes" response="{{votes}}"></site-ajax>
		<site-ajax id="myVoteAjax" cache="true" url="/votes/me" response="{{myVotes}}" auto="false"></site-ajax>
		<site-ajax id="voteAjax" auto="false" url="{{voteUri}}" on-core-response="{{handleVoteResponse}}"></site-ajax>
		<div layout vertical>
			<div id="count" site-font="caption" layout horizontal center-center>{{vote.numberOfVotes || 'no'}} fav{{vote.numberOfVotes > 1 ? 's' : ''}}</div>
			<paper-icon-button id="button" class="{{ {'voted':myVote} | tokenList}}" icon="{{myVote ? 'favorite' : 'favorite-outline'}}" on-tap="{{toggleVote}}"></paper-icon-button>
		</div>
	</template>
	<script>
		(function () {
			'use strict';

			Polymer({
				vote: {},
				myVote: null,
				myVotes: [],
				sessionResource: null,

				observe: {
					'globals.user': 'updateMyVotesUponLogout'
				},

				updateMyVotesUponLogout: function(oldValue, newValue) {
					if (newValue === null) {
						this.myVote = null;
						this.myVotes = [];
					} else {
						this.$.myVoteAjax.go();
					}
				},

				votesChanged: function () {
					this.vote = this.votes.filter(function (vote) {
						return vote.session === this.sessionResource;
					}.bind(this))[0] || {numberOfVotes: 0, session: this.sessionResource};
				},

				myVotesChanged: function () {
					if (!this.myVotes) {
						this.myVote = null;
					} else {
						this.myVote = this.myVotes.filter(function (vote) {
							return vote.session === this.sessionResource;
						}.bind(this))[0];
					}
				},

				toggleVote: function (event) {
					event.stopPropagation();

					if (!this.globals.user) {
						var t = document.getElementById('t');
						t.requireLogin((function() {
							this.toggleVote(event);
						}).bind(this));
						return;
					}

					var voteAjax = this.$.voteAjax;
					if (voteAjax.loading) {
						return;
					}

					if (this.myVote) {
						voteAjax.method = 'DELETE';
						this.vote.numberOfVotes--;
						this.myVote = false;
					} else {
						voteAjax.method = 'POST';
						this.myVote = true;
						this.vote.numberOfVotes++;
					}

					voteAjax.go();
				},

				handleVoteResponse: function (event) {
					this.myVote = event.detail.response !== null;
				}

			});

		})();
	</script>
</polymer-element>
