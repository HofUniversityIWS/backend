<link rel="import" href="../../bower_components/pvc-globals/pvc-globals.html">

<polymer-element name="site-comments" attributes="identifier title url categoryId https">
	<template>
		<pvc-globals id="globals"></pvc-globals>
		<style>
			:host {
				display: block;
			}
		</style>
		<div id="disqus_thread"></div>
	</template>
	<script>
		var disqus_shortname = 't3dd15';
		var disqusEmbedScript = null;
		var oneDisqusRendered = false;

		function loadDisqus() {
			if(disqusEmbedScript !== null) return;
			disqusEmbedScript = document.createElement('script');
			disqusEmbedScript.type = 'text/javascript';
			disqusEmbedScript.async = true;
			disqusEmbedScript.src = '//' + disqus_shortname + '.disqus.com/embed.js';
			(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(disqusEmbedScript);
		}

		Polymer({
			apiKey: 'znwrc1OQ5pQ4sWwjE5ebu0RlHpM66R03lCBEsaJ3Q2CglW5YdVNbSRt86vi3BAzw',

			remoteAuth: '',

			observe: {
				'$.globals.values.user.disqusRemoteAuth': 'updateRemoteAuth',
				'identifier': 'reset',
				'title': 'reset',
				'url': 'reset',
				'categoryId': 'reset',
				'remoteAuth': 'reset'
			},

			resetScheduled: false,

			updateRemoteAuth: function(oldValue, newValue) {
				this.remoteAuth = newValue;
			},

			domReady: function() {
				this.render();
			},

			render: function() {
				if(this.bodyDisqus !== null) return;

				loadDisqus();

				if(oneDisqusRendered) return this.reset();

				this.localDisqus = null;
				this.bodyDisqus = this.$.disqus_thread;

				window.disqus_config = this.disqusConfig;
			},

			reset: function() {
				if(!window.DISQUS || this.bodyDisqus) {
					this.resetScheduled = true;
					return;
				}
				this.resetScheduled = false;

				this.localDisqus = null;
				this.bodyDisqus = this.$.disqus_thread;

				DISQUS.reset({
					reload: true,
					config: this.disqusConfig
				});
			},

			get disqusConfig() {
				var el = this;
				return function() {
					if(el.identifier) this.page.identifier = el.identifier;
					if(el.title) this.page.title = el.title;
					if(el.url) this.page.url = el.url;
					if(el.categoryId) this.page.category_id = el.categoryId;
					if(el.apiKey) this.page.api_key = el.apiKey;
					if(el.remoteAuth) this.page.remote_auth_s3 = el.remoteAuth;
					this.callbacks.onReady = [(function() {
						if(!(el.bodyDisqus instanceof Node)) return;
						el.localDisqus = el.bodyDisqus;
						el.bodyDisqus = null;
						oneDisqusRendered = true;
						if (el.resetScheduled) {
							el.reset.call(el);
						}
					})];
					el.bodyDisqus.addElementListener('load', console.log);
				};
			},

			get localDisqus() {
				return this.shadowRoot.getElementById('disqus_thread');
			},

			set localDisqus(node) {
				if (node === null) {
					var existing = this.shadowRoot.getElementById('disqus_thread');
					if (existing) {
						existing.parentNode.removeChild(existing);
					}
					return;
				}
				this.shadowRoot.appendChild(node);
			},

			get bodyDisqus() {
				return document.getElementById('disqus_thread');
			},

			set bodyDisqus(node) {
				if (node === null) {
					var existing = document.getElementById('disqus_thread');
					if (existing) {
						existing.parentNode.removeChild(existing);
					}
					return;
				}
				return document.body.appendChild(node);
			}
		});
	</script>
</polymer-element>