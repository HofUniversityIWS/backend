<link rel="import" href="../bower_components/firebase-element/firebase-element.html">
<link rel="import" href="../bower_components/pvc-globals/pvc-globals.html">
<link rel="import" href="../bower_components/marked-element/marked-element.html">

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-input/paper-autogrow-textarea.html">
<link rel="import" href="../bower_components/paper-radio-group/paper-radio-group.html">

<link rel="import" href="../elements/form/validation/validation.html">
<polymer-element name="session-new">
	<template>
		<style>
			:host {
				display: block;
			}

			.session {
				padding: 20px;
				background: #fff;
			}

			paper-autogrow-textarea {
				width: 100%;
				margin-bottom: 30px;
			}
		</style>
		<pvc-globals values="{{globals}}"></pvc-globals>
		<firebase-element id="base" location="https://fiery-heat-3091.firebaseio.com/sessions" data="{{sessions}}" childEvents on-child-added="{{childAdded}}"></firebase-element>

		<paper-shadow z="1">
			<div class="session">
				<h2>Register a new session</h2>

				<div horizontal layout>
					<form id="session" is="form-validation" flex>
						<paper-input-decorator label="Session title" floatingLabel error="Enter a session title!">
							<input id="title" value="{{formData.title}}" is="core-input" required="">
						</paper-input-decorator>
						<paper-input-decorator label="Describe your session" floatingLabel error="Enter a session description!">
							<paper-autogrow-textarea>
								<textarea id="description" placeholder="Describe your session" value="{{formData.description}}" required=""></textarea>
							</paper-autogrow-textarea>
						</paper-input-decorator>

						<paper-button raised on-click="{{addSession}}">Register</paper-button>
					</form>
					<div class="preview" flex>
						<h3>{{formData.title}}</h3>
						<marked-element text="{{formData.description}}"></marked-element>
					</div>
				</div>
			</div>
		</paper-shadow>
	</template>
	<script>
		(function () {
			'use strict';

			Polymer({
				formData: {
					title: '',
					description: '',
					timestamp: new Date().getTime()
				},

				ready: function () {
					var self = this;
					this.$.session.addEventListener('submitting', function () {
						self.formData.user = self.globals.currentUser;
						self.formData.timestamp = new Date().getTime();
						self.$.base.push(self.formData);
					});
				},
				addSession: function () {
					this.$.session.fire('submit');
				},
				childAdded: function (event) {
					if (event.detail.value.timestamp === this.formData.timestamp) {
						window.location.href = '/session/' + event.detail.name;
					}
				}
			});

		})();
	</script>
</polymer-element>
